<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>衣服の購買における金銭感覚の調査</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f3f4f6;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        #orientation-message { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.9); color:white; font-size:1.25rem; font-weight:bold; justify-content:center; align-items:center; text-align:center; z-index:1000; padding:1rem; }
        #survey-container { display:block; max-width:800px; width:100%; }
        .modal { display:none; position:fixed; z-index:1001; left:0; top:0; width:100%; height:100%; overflow:auto; background-color: rgba(0,0,0,0.4); justify-content:center; align-items:center; }
        .modal-content { background-color:#ffffff; margin:auto; padding:2rem; border-radius:0.75rem; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05); text-align:center; max-width:90%; width:400px; }
        .survey-page { display:none; opacity:0; transition: opacity 0.5s ease-in-out; }
        .survey-page.active { display:block; opacity:1; }
        .custom-radio-group { display:flex; align-items:center; justify-content:center; width:100%; max-width:700px; margin:0 auto; }
        .custom-radio-item { flex:1; min-width:0; position:relative; padding:0 8px; }
        .custom-radio-item label { text-align:center; width:100%; display:block; white-space:normal; word-break:keep-all; }
        .custom-radio-item:not(:last-child)::after { content: ""; position:absolute; top:20%; left:50%; transform:translate(30%, -50%); width:90px; height:2px; background:#a0aec0; z-index:0; }
        .hidden { display:none !important; }
    </style>
</head>
<body>
    <div id="orientation-message" class="hidden">
        <p id="orientation-text">スマホは<span class="text-yellow-400">横画面かつ全画面</span>、パソコンは<span class="text-yellow-400">全画面</span>で回答してください。</p>
    </div>

    <div id="survey-container" class="bg-white p-8 rounded-lg shadow-xl border border-gray-200 max-w-2xl w-full">
        <h1 id="main-survey-title" class="text-4xl font-extrabold text-gray-900 mb-8 text-center">衣服の購買における金銭感覚の調査</h1>
        <form id="survey-form" class="space-y-6">
            <!-- ページ0: 表紙 -->
            <div class="survey-page active" data-page="0">
                <p class="text-gray-700 text-lg mb-10 text-center">
                    この度は、調査にご協力いただき、ありがとうございます。<br><br>
                    調査対象者は、専門学生・短期大学生・大学生・大学院生・もしくは学生でない18～22歳の方です。<br>
                    該当しない方・既に回答している方は、ブラウザを閉じてください。<br><br>
                    【研究代表者】<br>
                    静岡県立大学　経営情報学部　4年　野村優介<br>
                </p>
                <div class="flex justify-center mt-12">
                    <button type="button" onclick="nextPage()" class="py-3 px-10 rounded-md bg-indigo-600 text-white">次へ</button>
                </div>
            </div>

            <!-- ページ1: 同意 -->
            <div class="survey-page" data-page="1">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">研究参加への同意</h2>
                <p class="text-gray-700 mb-8">
                    この調査は卒業研究の一環で行われます。<br>
                    この調査では、あなたの家庭での経験が、衣服の購買における現在の金銭的な価値観に影響を与えるのかどうかを明らかにすることを目的としています。<br>
                    この調査には、正しい回答や間違った回答、社会的に望ましい回答などはありません。<br>
                    貴重なお時間を頂戴し、誠に恐縮ですが、なにとぞ、あなたの経験や考えに沿って、まじめに回答していただけると幸いです。<br>
                    <br>
                    調査へご参加いただける方は「同意する」、参加しない方は「同意しない」を選択し、「次へ」を押してください。<br>
                    何かご不明な点等ございましたら、下記へご連絡ください。<br>
                    <br>
                    【お問い合わせ先】<br>
                    静岡県立大学　経営情報学部　4年　野村優介<br>
                    e-mail: b22091@u-shizuoka-ken.ac.jp
                </p>
                <div class="mb-6">
                    <div class="flex items-center space-x-6">
                        <div class="flex items-center">
                            <input id="agree-radio" name="同意" type="radio" value="同意する" required>
                            <label for="agree-radio" class="ml-3">同意する</label>
                        </div>
                        <div class="flex items-center">
                            <input id="disagree-radio" name="同意" type="radio" value="同意しない" required>
                            <label for="disagree-radio" class="ml-3">同意しない</label>
                        </div>
                    </div>
                </div>
                <div class="flex justify-between mt-6">
                    <button type="button" onclick="prevPage()" class="py-2 px-6 rounded-md bg-white border">戻る</button>
                    <button type="button" onclick="nextPageConditional()" class="py-2 px-6 rounded-md bg-indigo-600 text-white">次へ</button>
                </div>
            </div>

            <!-- ページ2: 金銭的教育（親／学校） -->
            <div class="survey-page" data-page="2">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">金銭的教育についての質問</h2>

                <!-- 親の教育グループ -->
                <div class="mb-6" id="parent-education-types">
                  <label class="block text-sm font-medium text-gray-700 mb-2">育ての親からどのような方法でお金について教わりましたか（該当するものすべて選んでください）</label>
                  <div class="mt-2 space-y-2">
                    <div class="flex items-center"><input id="parent_edu_saving" name="親の教育" type="checkbox" value="貯金"><label for="parent_edu_saving" class="ml-3">貯金を習慣づけられた</label></div>
                    <div class="flex items-center"><input id="parent_edu_way" name="親の教育" type="checkbox" value="使い方"><label for="parent_edu_way" class="ml-3">お金の使い方を自分で考えること</label></div>
                    <div class="flex items-center"><input id="parent_edu_allowance" name="親の教育" type="checkbox" value="毎月のお小遣い"><label for="parent_edu_allowance" class="ml-3">毎月のお小遣いの管理を自分でさせられた</label></div>
                    <div class="flex items-center"><input id="parent_edu_shopping" name="親の教育" type="checkbox" value="買い物"><label for="parent_edu_shopping" class="ml-3">実際に買い物に連れていき見本を示した</label></div>
                    <div class="flex items-center"><input id="parent_edu_verbal" name="親の教育" type="checkbox" value="口頭"><label for="parent_edu_verbal" class="ml-3">お金とは何かを理論的に説明した</label></div>
                    <div class="flex items-center"><input id="parent_edu_none" name="親の教育" type="checkbox" value="教わっていない"><label for="parent_edu_none" class="ml-3">教わっていない</label></div>

                    <!-- その他（ユニーク id） -->
                    <div class="flex items-center">
                      <input id="parent_edu_other_cb" name="親の教育" type="checkbox" value="その他" data-has-other="true" data-other-target="parent_edu_other_text">
                      <label for="parent_edu_other_cb" class="ml-3">その他（具体的に記入してください）</label>
                    </div>
                    <div id="parent_edu_other_text_container" class="mt-2 ml-6 hidden">
                      <input id="parent_edu_other_text" name="親の教育_その他" type="text" placeholder="具体的にご記入ください" class="w-full">
                    </div>
                  </div>
                </div>

                <div class="border-b border-gray-300 my-6 w-full"></div>

                <!-- 学校の教育グループ -->
                <div class="mb-6" id="school-education-types">
                  <label class="block text-sm font-medium text-gray-700 mb-2">学校ではどのような方法でお金について教わりましたか（該当するものすべて選んでください）</label>
                  <div class="mt-2 space-y-2">
                    <div class="flex items-center"><input id="school_edu_class" name="学校の教育" type="checkbox" value="授業"><label for="school_edu_class" class="ml-3">理論的な概要を授業で</label></div>
                    <div class="flex items-center"><input id="school_edu_workshop" name="学校の教育" type="checkbox" value="ワークショップ"><label for="school_edu_workshop" class="ml-3">ワークショップや体験学習</label></div>
                    <div class="flex items-center"><input id="school_edu_trial" name="学校の教育" type="checkbox" value="体験"><label for="school_edu_trial" class="ml-3">職場体験や外部講師の授業</label></div>
                    <div class="flex items-center"><input id="school_edu_none" name="学校の教育" type="checkbox" value="教わっていない"><label for="school_edu_none" class="ml-3">教わっていない</label></div>

                    <!-- その他（ユニーク id） -->
                    <div class="flex items-center">
                      <input id="school_edu_other_cb" name="学校の教育" type="checkbox" value="その他" data-has-other="true" data-other-target="school_edu_other_text">
                      <label for="school_edu_other_cb" class="ml-3">その他（具体的に記入してください）</label>
                    </div>
                    <div id="school_edu_other_text_container" class="mt-2 ml-6 hidden">
                      <input id="school_edu_other_text" name="学校の教育_その他" type="text" placeholder="具体的にご記入ください" class="w-full">
                    </div>
                  </div>
                </div>

                <div class="border-b border-gray-300 my-6 w-full"></div>

                <!-- 親の教育時期 -->
                <div class="mb-6" id="parent-education-period">
                  <label class="block text-sm font-medium text-gray-700 mb-2">育ての親からお金について教わった時期（該当するものすべて選んでください）</label>
                  <div class="mt-2 space-y-2">
                    <div class="flex items-center"><input id="parent_teaching_parent_age_1" name="親の教育時期" type="checkbox" value="1"><label for="parent_teaching_parent_age_1" class="ml-3">小学校入学まで</label></div>
                    <div class="flex items-center"><input id="parent_teaching_parent_age_2" name="親の教育時期" type="checkbox" value="2"><label for="parent_teaching_parent_age_2" class="ml-3">小学校低学年</label></div>
                    <div class="flex items-center"><input id="parent_teaching_parent_age_3" name="親の教育時期" type="checkbox" value="3"><label for="parent_teaching_parent_age_3" class="ml-3">小学校高学年</label></div>
                    <div class="flex items-center"><input id="parent_teaching_parent_age_4" name="親の教育時期" type="checkbox" value="4"><label for="parent_teaching_parent_age_4" class="ml-3">中学生</label></div>
                    <div class="flex items-center"><input id="parent_teaching_parent_age_5" name="親の教育時期" type="checkbox" value="5"><label for="parent_teaching_parent_age_5" class="ml-3">高校生</label></div>
                    <div class="flex items-center"><input id="parent_teaching_parent_age_99" name="親の教育時期" type="checkbox" value="99"><label for="parent_teaching_parent_age_99" class="ml-3">教わってない</label></div>

                    <!-- その他（ユニーク id） -->
                    <div class="flex items-center">
                      <input id="parent_period_other_cb" name="親の教育時期" type="checkbox" value="その他" data-has-other="true" data-other-target="parent_period_other_text">
                      <label for="parent_period_other_cb" class="ml-3">その他（具体的に記入してください）</label>
                    </div>
                    <div id="parent_period_other_text_container" class="mt-2 ml-6 hidden">
                      <input id="parent_period_other_text" name="親の教育時期_その他" type="text" placeholder="具体的にご記入ください" class="w-full">
                    </div>
                  </div>
                </div>

                <div class="border-b border-gray-300 my-6 w-full"></div>

                <!-- 学校の教育時期 -->
                <div class="mb-6" id="school-education-period">
                  <label class="block text-sm font-medium text-gray-700 mb-2">学校からお金について教わった時期（該当するものすべて選んでください）</label>
                  <div class="mt-2 space-y-2">
                    <div class="flex items-center"><input id="school_teaching_parent_age_1" name="学校の教育時期" type="checkbox" value="1"><label for="school_teaching_parent_age_1" class="ml-3">小学校低学年</label></div>
                    <div class="flex items-center"><input id="school_teaching_parent_age_2" name="学校の教育時期" type="checkbox" value="2"><label for="school_teaching_parent_age_2" class="ml-3">小学校高学年</label></div>
                    <div class="flex items-center"><input id="school_teaching_parent_age_3" name="学校の教育時期" type="checkbox" value="3"><label for="school_teaching_parent_age_3" class="ml-3">中学生</label></div>
                    <div class="flex items-center"><input id="school_teaching_parent_age_4" name="学校の教育時期" type="checkbox" value="4"><label for="school_teaching_parent_age_4" class="ml-3">高校生</label></div>
                    <div class="flex items-center"><input id="school_teaching_parent_age_99" name="学校の教育時期" type="checkbox" value="99"><label for="school_teaching_parent_age_99" class="ml-3">教わってない</label></div>

                    <!-- その他（ユニーク id） -->
                    <div class="flex items-center">
                      <input id="school_period_other_cb" name="学校の教育時期" type="checkbox" value="その他" data-has-other="true" data-other-target="school_period_other_text">
                      <label for="school_period_other_cb" class="ml-3">その他（具体的に記入してください）</label>
                    </div>
                    <div id="school_period_other_text_container" class="mt-2 ml-6 hidden">
                      <input id="school_period_other_text" name="学校の教育時期_その他" type="text" placeholder="具体的にご記入ください" class="w-full">
                    </div>
                  </div>
                </div>

                <!-- 購買頻度など -->
                <div class="border-b border-gray-300 my-6 w-full"></div>
                <div class="mb-6">
                    <label for="purchase-frequency" class="block text-sm font-medium text-gray-700 mb-1">あなたは普段どれくらいの頻度で衣服を購入していますか</label>
                    <select id="purchase-frequency" name="購買頻度" required class="mt-1 block w-full">
                        <option value="">選択してください</option>
                        <option value="1ヶ月に1回より多い">1ヶ月に1回より多い</option>
                        <option value="1ヶ月に1回程度">1ヶ月に1回程度</option>
                        <option value="2ヶ月に1回程度">2ヶ月に1回程度</option>
                        <option value="3ヶ月に1回程度">3ヶ月に1回程度</option>
                        <option value="4か月に1回程度かそれ以下">4か月に1回程度かそれ以下</option>
                    </select>
                </div>

                <div class="flex justify-end mt-6">
                    <button type="button" onclick="nextPage()" class="py-2 px-6 rounded-md bg-indigo-600 text-white">次へ</button>
                </div>
            </div>

            <!-- ページ3: 次のセクション説明 -->
            <div class="survey-page" data-page="3">
                <h2 class="text-2xl font-semibold">次のセクションについて</h2>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="nextPage()" class="py-2 px-6 rounded-md bg-indigo-600 text-white">次へ</button>
                </div>
            </div>

            <!-- ページ4: ランダムfamily questions -->
            <div class="survey-page" data-page="4">
                <div id="random-question-content" class="text-center"></div>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="nextPage()" class="py-2 px-6 rounded-md bg-indigo-600 text-white">次へ</button>
                </div>
            </div>

            <!-- ページ5: シミュレーション説明 -->
            <div class="survey-page" data-page="5">
                <h2 class="text-2xl font-semibold">衣服の購買シミュレーション説明</h2>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="nextPage()" class="py-2 px-6 rounded-md bg-indigo-600 text-white">次へ</button>
                </div>
            </div>

            <!-- ページ6: 購買シミュレーション -->
            <div class="survey-page" data-page="6">
                <h2 class="text-2xl font-semibold">購買シミュレーション</h2>
                <div class="flex flex-col items-center p-4 bg-gray-50 rounded-lg mb-6">
                    <img id="clothing-image" src="" alt="Clothing Item" class="mb-4 w-full max-w-sm rounded-md">
                    <p>種類: <span id="clothing-item-type"></span></p>
                    <p>希少性: <span id="clothing-combination"></span></p>
                    <p>機能性: <span id="clothing-situation"></span></p>
                    <p class="text-2xl font-bold">価格: <span id="current-price"></span>円</p>
                    <div class="flex space-x-4 mt-4">
                        <button type="button" id="buy-button" onclick="handlePurchaseChoice('buy')" class="py-2 px-6 rounded-md bg-green-600 text-white">買う</button>
                        <button type="button" id="dont-buy-button" onclick="handlePurchaseChoice('donotbuy')" class="py-2 px-6 rounded-md bg-red-600 text-white">買わない</button>
                    </div>
                </div>
            </div>

            <!-- ページ7: 収入等（親の支援に「その他」追加） -->
            <div class="survey-page" data-page="7">
                <h2 class="text-2xl font-semibold">収入などについての質問</h2>

                <div class="mb-6">
                    <label for="part-time-income" class="block text-sm font-medium">あなたのひと月のアルバイトの収入を教えてください</label>
                    <select id="part-time-income" name="アルバイトの収入" required class="mt-1 block w-full">
                        <option value="">選択してください</option>
                        <option value="0">アルバイトをしていない（学生）</option>
                        <option value="1">月5万円未満</option>
                        <option value="2">月5～6万円未満</option>
                        <option value="3">月6～7万円未満</option>
                        <option value="4">月7～8万円未満</option>
                        <option value="5">月8万円以上</option>
                        <option value="98">就職している</option>
                        <option value="99">アルバイトをしていない（学生でなく、就職していない）</option>
                    </select>
                </div>

                <div class="border-b border-gray-300 my-6"></div>

                <!-- 親の支援（ここにその他を追加） -->
                <div class="mb-6" id="parent-education-expense-support-block">
                  <label class="block text-sm font-medium mb-2">保護者からの経済的支援はありますか（該当するものすべて選択してください）</label>
                  <div class="mt-2 space-y-2">
                    <div class="flex items-center"><input id="parent_support_rent" name="親の支援" type="checkbox" value="家賃補助"><label for="parent_support_rent" class="ml-3">家賃補助</label></div>
                    <div class="flex items-center"><input id="parent_support_tuition" name="親の支援" type="checkbox" value="学費支援"><label for="parent_support_tuition" class="ml-3">学費支援</label></div>
                    <div class="flex items-center"><input id="parent_support_allowance" name="親の支援" type="checkbox" value="毎月のお小遣い"><label for="parent_support_allowance" class="ml-3">毎月の使い道が自由な仕送り</label></div>
                    <div class="flex items-center"><input id="parent_support_occasional" name="親の支援" type="checkbox" value="代わりに買う"><label for="parent_support_occasional" class="ml-3">必要なものを代わりに買ってくれる</label></div>
                    <div class="flex items-center"><input id="parent_support_none" name="親の支援" type="checkbox" value="支援なし"><label for="parent_support_none" class="ml-3">支援なし</label></div>

                    <!-- 親の支援の「その他」 -->
                    <div class="flex items-center">
                      <input id="parent_support_other_cb" name="親の支援" type="checkbox" value="その他" data-has-other="true" data-other-target="parent_support_other_text">
                      <label for="parent_support_other_cb" class="ml-3">その他（具体的に記入してください）</label>
                    </div>
                    <div id="parent_support_other_text_container" class="mt-2 ml-6 hidden">
                      <input id="parent_support_other_text" name="親の支援_その他" type="text" placeholder="具体的にご記入ください" class="w-full">
                    </div>
                  </div>
                </div>

                <div class="flex justify-end mt-6">
                    <button type="button" onclick="nextPage()" class="py-2 px-6 rounded-md bg-indigo-600 text-white">次へ</button>
                </div>
            </div>

            <!-- ページ8: 基本情報 -->
            <div class="survey-page" data-page="8">
                <h2 class="text-2xl font-semibold">基本情報</h2>
                <div class="mb-6">
                    <label for="age" class="block text-sm font-medium">あなたの年齢を入力してください（半角数字）</label>
                    <input type="number" id="age" name="年齢" required class="mt-1 block w-full rounded-md border">
                </div>
                <!-- 性別 / 所属 / 所属世帯 など（省略表示） -->
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="nextPage()" class="py-2 px-6 rounded-md bg-indigo-600 text-white">次へ</button>
                </div>
            </div>

            <!-- ページ9: 完了 -->
            <div class="survey-page" data-page="9">
                <h2 class="text-2xl font-semibold text-center">調査完了</h2>
                <p class="text-center font-bold">調査は以上です。回答を送信してください。</p>
                <div class="flex justify-center mt-6">
                    <button type="submit" id="submit-button-final" class="py-2 px-6 rounded-md bg-indigo-600 text-white">回答を送信</button>
                </div>
            </div>
        </form>
    </div>

    <div id="statusModal" class="modal">
        <div class="modal-content">
            <p id="modal-message"></p>
            <div id="loading-spinner" class="hidden mt-4">送信中...</div>
            <button id="modal-close-button" class="hidden mt-6 py-2 px-4 bg-indigo-600 text-white rounded-md">閉じる</button>
        </div>
    </div>

    <script>
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx-eu-h9B5aFMiPpR2nOGF1gOUVc-IqPHlFUp0qJyFuuVcr7WjQCh-A5QySKPc35c94/exec';

        const form = document.getElementById('survey-form');
        const surveyPages = document.querySelectorAll('.survey-page');
        const mainSurveyTitle = document.getElementById('main-survey-title');
        const statusModal = document.getElementById('statusModal');
        const modalMessage = document.getElementById('modal-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const modalCloseButton = document.getElementById('modal-close-button');

        const currentPriceSpan = document.getElementById('current-price');
        const buyButton = document.getElementById('buy-button');
        const dontBuyButton = document.getElementById('dont-buy-button');
        const submitButtonFinal = document.getElementById('submit-button-final');
        const clothingImage = document.getElementById('clothing-image');
        const clothingItemTypeSpan = document.getElementById('clothing-item-type');
        const clothingCombinationSpan = document.getElementById('clothing-combination');
        const clothingSituationSpan = document.getElementById('clothing-situation');

        const allClothingSimulationsData = [
            { id: "sim_formal_high_high", itemType: "フォーマルなジャケット", combination: "高い", situation: "高い", imageUrl: "" },
            { id: "sim_casual_normal_normal", itemType: "カジュアルなジャケット", combination: "普通", situation: "普通", imageUrl: "" },
        ];

        const familyQuestionsData = [
            { title: "自分の実家は裕福だと感じる", name: "裕福", options: ["全くあてはまらない","あてはまらない","どちらともいえない","あてはまる","とてもあてまる"] },
            { title: "育ての親は倹約家である", name: "親は倹約", options: ["全くあてはまらない","あてはまらない","どちらともいえない","あてはまる","とてもあてまる"] },
            { title: "育ての親はファッションに関心がある", name: "親ファッション", options: ["全くあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてまる"] },
            { title: "幼少期から高校生の期間、お金を上手く活用するように教えられた", name: "活用", options: ["全くあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてまる"] },
            { title: "幼少期から高校生の期間、欲しいものは何でも買ってもらえた",name: "欲しいものは何でも", options: ["全くあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてまる" ] },
            { title: "幼少期から高校生の期間、欲しいものを買ってもらうにはルールがあった<br>（良い成績を取る、お手伝いをするなど）", name: "ルール", options: ["全くあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてまる" ] },
            { title: "幼少期から高校生の期間、理由があれば欲しいものを買ってもらえた",name: "理由", options: ["全くあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてまる"] },
            { title: "幼少期から高校生の期間、自分のお小遣いで買ったものが不要なものだと言われた", name: "不要", options: ["全くあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてまる" ] },
            { title: "服を買うとき、育ての親の意見に影響される", name: "親の意見", options: ["全くあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてまる" ] },
            { title: "保護者からの金銭教育は現在のあなたの金銭管理に役立っていると感じる", name: "親役立つ", options: ["全くあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてまる"] },
            { title: "学校からの金銭教育は現在のあなたの金銭管理に役立っていると感じる", name: "学校役立つ", options: ["全くあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてまる" ] },
            { title: "自分は計画的な金銭管理ができていると感じる", name: "計画的", options: ["全くあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてまる" ] },
            { title: "「あてはまる」を選択してください", name: "トラップ", options: ["全くあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてまる"] }
        ];

        let shuffledClothingSimulations = [];
        let currentSimulationRoundIndex = 0;
        let currentSimulationData = null;

        let currentPageIndex = 0;
        let clothingPrice = 0;
        let lastChoice = null;
        let surveyAnswers = {};

        let shuffledFamilyQuestionIndices = [];
        let currentFamilyQuestionIndexInShuffledOrder = 0;

        let initialPrice = 0;
        let finished = false;

        const randomQuestionContainer = document.getElementById('random-question-content');
        const orientationMessage = document.getElementById('orientation-message');
        const orientationText = document.getElementById('orientation-text');
        const surveyContainer = document.getElementById('survey-container');

        let priceHistory = [];

        // orientation control
        function isSmartphone() { return /Mobi|Android|iPhone|iPod/.test(navigator.userAgent); }
        function isLandscape() { return window.innerWidth >= window.innerHeight; }
        const PORTRAIT_FROM_PAGE = 6;

        function checkOrientationRequirement() {
            if (!isSmartphone()) {
                if (isLandscape()) { orientationMessage.style.display = 'none'; surveyContainer.style.display = 'block'; }
                else { orientationText.innerHTML = 'パソコンは横向きで続けてください。'; orientationMessage.style.display = 'flex'; surveyContainer.style.display = 'none'; }
                return;
            }
            const requiresPortrait = currentPageIndex >= PORTRAIT_FROM_PAGE;
            if (requiresPortrait) {
                if (isLandscape()) { orientationText.innerHTML = 'この先は縦画面で回答してください。'; orientationMessage.style.display = 'flex'; surveyContainer.style.display = 'none'; }
                else { orientationMessage.style.display = 'none'; surveyContainer.style.display = 'block'; }
            } else {
                if (isLandscape()) { orientationMessage.style.display = 'none'; surveyContainer.style.display = 'block'; }
                else { orientationText.innerHTML = 'スマホは横画面で回答してください。'; orientationMessage.style.display = 'flex'; surveyContainer.style.display = 'none'; }
            }
        }

        function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }

        function updatePageDisplay() {
            surveyPages.forEach((page, index) => { if (index === currentPageIndex) page.classList.add('active'); else page.classList.remove('active'); });

            if (currentPageIndex === 0 || currentPageIndex === 9) mainSurveyTitle.classList.remove('hidden'); else mainSurveyTitle.classList.add('hidden');

            // Restore saved parent support (page7)
            if (currentPageIndex === 7) {
                const saved = surveyAnswers['親の支援'];
                if (Array.isArray(saved)) {
                    // clear existing
                    document.querySelectorAll('input[name="親の支援"]').forEach(cb => cb.checked = false);
                    const allCbs = document.querySelectorAll('input[name="親の支援"]');
                    saved.forEach(val => {
                        // If saved entry is "その他: text", handle separately below
                        if (typeof val === 'string' && val.startsWith('その他:')) return;
                        for (const cb of allCbs) { if (cb.value === val) { cb.checked = true; break; } }
                    });
                    // restore その他 if present
                    const otherEntry = saved.find(s => typeof s === 'string' && s.startsWith('その他:'));
                    if (otherEntry) {
                        const otherText = otherEntry.replace(/^その他:\s*/, '');
                        const otherCb = document.querySelector('input[name="親の支援"][value="その他"]');
                        if (otherCb) {
                            otherCb.checked = true;
                            const txtId = otherCb.dataset.otherTarget || 'parent_support_other_text';
                            const txtEl = document.getElementById(txtId);
                            const container = document.getElementById(txtId + '_container');
                            if (container) container.classList.remove('hidden');
                            if (txtEl) txtEl.value = otherText;
                        }
                    }
                }
            }

            // Random family question page (page4)
            if (currentPageIndex === 4) {
                if (shuffledFamilyQuestionIndices.length === 0) {
                    shuffledFamilyQuestionIndices = Array.from({ length: familyQuestionsData.length }, (_, i) => i);
                    shuffleArray(shuffledFamilyQuestionIndices);
                    currentFamilyQuestionIndexInShuffledOrder = 0;
                }
                const originalQuestionIndex = shuffledFamilyQuestionIndices[currentFamilyQuestionIndexInShuffledOrder];
                const questionData = familyQuestionsData[originalQuestionIndex];
                randomQuestionContainer.innerHTML = `
                    <h2 class="text-2xl font-semibold mb-6">${questionData.title}</h2>
                    <div class="mb-10">
                        <div class="flex items-center justify-center gap-0 custom-radio-group">
                            ${questionData.options.map((option, idx) => `
                                <div class="flex flex-col items-center flex-1 relative custom-radio-item">
                                    <input id="${questionData.name}-${idx}" name="${questionData.name}_${originalQuestionIndex}" type="radio" value="${option}">
                                    <label for="${questionData.name}-${idx}" class="mt-1 block text-sm">${option}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                const storedAnswerKey = `${questionData.name}_${originalQuestionIndex}`;
                if (surveyAnswers[storedAnswerKey]) {
                    const radio = randomQuestionContainer.querySelector(`input[name="${storedAnswerKey}"][value="${surveyAnswers[storedAnswerKey]}"]`);
                    if (radio) radio.checked = true;
                }
            } else {
                if (randomQuestionContainer) randomQuestionContainer.innerHTML = '';
            }

            // start simulation when arriving at page6
            if (currentPageIndex === 6) startClothingPurchaseSimulation();

            checkOrientationRequirement();
            window.scrollTo(0, 0);
        }

        // validation including "その他" text requirement
        function validateOtherTextFields(currentPage) {
          const otherCheckboxes = currentPage.querySelectorAll('input[type="checkbox"][data-has-other="true"]');
          for (const cb of otherCheckboxes) {
            const otherId = cb.dataset.otherTarget;
            if (!otherId) continue;
            const textEl = document.getElementById(otherId);
            if (cb.checked) {
              if (!textEl || String(textEl.value || '').trim() === '') return false;
            }
          }
          return true;
        }

        function validatePage() {
            let isValid = true;
            const currentPage = surveyPages[currentPageIndex];
            const requiredElements = currentPage.querySelectorAll('[required]');
            for (const element of requiredElements) {
                if (element.type === 'radio') {
                    const radioGroup = currentPage.querySelectorAll(`input[name="${element.name}"]`);
                    const isGroupChecked = Array.from(radioGroup).some(radio => radio.checked);
                    if (!isGroupChecked) { isValid = false; break; }
                } else if (element.type === 'checkbox') {
                    const checkboxGroup = currentPage.querySelectorAll(`input[name="${element.name}"]`);
                    const isGroupChecked = Array.from(checkboxGroup).some(cb => cb.checked);
                    if (!isGroupChecked) { isValid = false; break; }
                } else if (element.type === 'number' || element.tagName === 'SELECT' || element.tagName === 'TEXTAREA' || element.type === 'text') {
                    if (String(element.value || '').trim() === '') { isValid = false; break; }
                }
            }
            if (isValid && !validateOtherTextFields(currentPage)) isValid = false;
            return isValid;
        }

        function nextPage() {
            if (currentPageIndex === 0) { currentPageIndex = 1; updatePageDisplay(); return; }
            if (currentPageIndex === 1) { nextPageConditional(); return; }

            if (!validatePage()) { showModal('すべての質問に回答してください。', false); return; }

            // save parent support on page7 before advancing
            if (currentPageIndex === 7) {
                const selected = Array.from(document.querySelectorAll('input[name="親の支援"]:checked')).map(el => el.value);
                const otherCb = document.querySelector('input[name="親の支援"][value="その他"]');
                if (otherCb && otherCb.checked) {
                    const otherText = (document.getElementById(otherCb.dataset.otherTarget || 'parent_support_other_text')?.value || '').trim();
                    if (otherText) selected.push(`その他: ${otherText}`);
                }
                surveyAnswers['親の支援'] = selected;
            }

            // save random family question answers on page4
            if (currentPageIndex === 4) {
                const originalQuestionIndex = shuffledFamilyQuestionIndices[currentFamilyQuestionIndexInShuffledOrder];
                const questionData = familyQuestionsData[originalQuestionIndex];
                const selectedAnswer = document.querySelector(`input[name="${questionData.name}_${originalQuestionIndex}"]:checked`);
                if (selectedAnswer) surveyAnswers[`${questionData.name}_${originalQuestionIndex}`] = selectedAnswer.value;
                if (currentFamilyQuestionIndexInShuffledOrder < familyQuestionsData.length - 1) {
                    currentFamilyQuestionIndexInShuffledOrder++;
                } else {
                    currentPageIndex = 5; // after random questions go to simulation description
                    shuffledFamilyQuestionIndices = [];
                    currentFamilyQuestionIndexInShuffledOrder = 0;
                    updatePageDisplay();
                    return;
                }
            } else {
                currentPageIndex++;
            }
            updatePageDisplay();
        }

        function nextPageConditional() {
            const consentValue = document.querySelector('input[name="同意"]:checked')?.value;
            if (!consentValue) { showModal('研究参加への同意を選択してください。', false); return; }
            if (consentValue === '同意する') { currentPageIndex = 2; updatePageDisplay(); }
            else { currentPageIndex = 0; updatePageDisplay(); showModal('調査は終了しました。', false); }
        }

        function prevPage() { if (currentPageIndex > 0) { currentPageIndex--; updatePageDisplay(); } }

        // Simulation init
        function startClothingPurchaseSimulation() {
            if (shuffledClothingSimulations.length === 0) {
                shuffledClothingSimulations = allClothingSimulationsData.slice();
                shuffleArray(shuffledClothingSimulations);
                currentSimulationRoundIndex = 0;
            }
            currentSimulationData = shuffledClothingSimulations[currentSimulationRoundIndex];
            initialPrice = (currentSimulationData.itemType === "カジュアルなジャケット") ? 20000;
                            (currentSimulationData.itemType === "フォーマルなジャケット") ? 40000 : 1000;
            clothingPrice = initialPrice;
            finished = false;
            lastChoice = null;
            priceHistory = [{ price: clothingPrice, bounds: null }];
            updateClothingPriceAndImage();
            if (buyButton) buyButton.disabled = false;
            if (dontBuyButton) dontBuyButton.disabled = false;
            if (buyButton) buyButton.classList.remove('hidden');
            if (dontBuyButton) dontBuyButton.classList.remove('hidden');
        }

        function updateClothingPriceAndImage() {
            const price = (clothingPrice || 0);
            const el = document.getElementById('current-price');
            if (el) el.textContent = price.toLocaleString();
            if (currentSimulationData) {
                if (clothingImage && currentSimulationData.imageUrl) clothingImage.src = currentSimulationData.imageUrl;
                if (clothingItemTypeSpan) clothingItemTypeSpan.textContent = currentSimulationData.itemType || '';
                if (clothingCombinationSpan) clothingCombinationSpan.textContent = currentSimulationData.combination || '';
                if (clothingSituationSpan) clothingSituationSpan.textContent = currentSimulationData.situation || '';
            }
        }

        // Price transition logic (keeps "other" logic intact) - simplified but consistent
        function handlePurchaseChoice(choice) {
            if (finished) return;
            const currentEntry = priceHistory[priceHistory.length - 1];
            const currentPrice = currentEntry.price;
            const currentHundredsDigit = Math.floor(Math.abs(currentPrice) / 100) % 10;
            if (currentHundredsDigit === 5) {
                const finalChoiceText = (choice === 'buy') ? '買う' : '買わない';
                surveyAnswers[`${currentSimulationData.id}_最終結果`] = `${currentPrice}円で${finalChoiceText}`;
                if (buyButton) buyButton.disabled = true;
                if (dontBuyButton) dontBuyButton.disabled = true;
                if (buyButton) buyButton.classList.add('hidden');
                if (dontBuyButton) dontBuyButton.classList.add('hidden');
                finished = true;
                if (currentSimulationRoundIndex < shuffledClothingSimulations.length - 1) {
                    currentSimulationRoundIndex++;
                    setTimeout(startClothingPurchaseSimulation, 300);
                } else {
                    currentPageIndex = 7; // go to page7 after all simulation rounds
                    setTimeout(updatePageDisplay, 300);
                }
                return;
            }

            let newPrice = currentPrice;
            let newBounds = null;
            if (currentEntry.bounds) {
                const high = currentEntry.bounds.high;
                const low = currentEntry.bounds.low;
                if (choice === 'buy') {
                    let diff = Math.max(1, Math.abs(currentPrice - high));
                    let half = Math.max(1, Math.floor(diff / 2));
                    newPrice = Math.floor(Math.max(currentPrice, high) - half * (Math.max(currentPrice, high) === currentPrice ? -1 : 1));
                    // simpler: move toward high by half gap from current
                    newPrice = Math.floor((currentPrice + high) / 2);
                    newBounds = { high: Math.max(high, currentPrice), low: Math.min(high, currentPrice) };
                } else {
                    newPrice = Math.floor((currentPrice + low) / 2);
                    newBounds = { high: Math.max(currentPrice, low), low: Math.min(currentPrice, low) };
                }
            } else {
                const prevEntry = priceHistory.length >= 2 ? priceHistory[priceHistory.length - 2] : null;
                if (lastChoice === null || lastChoice === choice) {
                    if (choice === 'buy') newPrice = currentPrice * 2;
                    else newPrice = Math.max(Math.floor(currentPrice / 2), 2500);
                } else {
                    if (prevEntry) {
                        newPrice = Math.floor((currentPrice + prevEntry.price) / 2);
                        const high = Math.max(currentPrice, prevEntry.price);
                        const low = Math.min(currentPrice, prevEntry.price);
                        newBounds = { high, low };
                    } else {
                        if (choice === 'buy') newPrice = currentPrice * 2;
                        else newPrice = Math.max(Math.floor(currentPrice / 2), 2500);
                    }
                }
            }

            if (newPrice < 2500) newPrice = 2500;
            priceHistory.push({ price: newPrice, bounds: newBounds });
            clothingPrice = newPrice;
            lastChoice = choice;
            updateClothingPriceAndImage();
        }

        function showModal(message, isLoading = false) {
            modalMessage.innerHTML = message;
            if (isLoading) loadingSpinner.classList.remove('hidden'); else loadingSpinner.classList.add('hidden');
            statusModal.style.display = 'flex';
        }
        function closeModal() { statusModal.style.display = 'none'; }
        modalCloseButton.addEventListener('click', closeModal);
        window.addEventListener('click', (event) => { if (event.target == statusModal) closeModal(); });

        async function submitForm(event) {
            event.preventDefault();
            if (!GOOGLE_APPS_SCRIPT_URL) { showModal('エラー: Google Apps ScriptのURLが設定されていません。', false); return; }
            showModal('回答を送信しています...', true);

            const data = {};
            for (const key in surveyAnswers) data[key] = surveyAnswers[key];
            const formData = new FormData(form);
            const seenKeys = new Set();
            for (const key of formData.keys()) {
                if (seenKeys.has(key)) continue;
                seenKeys.add(key);
                const values = formData.getAll(key);
                data[key] = (values.length > 1) ? values : values[0];
            }

            try {
                await fetch(GOOGLE_APPS_SCRIPT_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type':'application/json'}, body: JSON.stringify(data) });
                showModal('回答が正常に送信されました。<br>もしよろしければ、お知り合いにもアンケートを共有して頂けると幸いです。<br>ご協力ありがとうございました。<br>【アンケートフォームURL】<br>https://researchforme.github.io/test/', false);
                form.reset();
                currentPageIndex = 0;
                updatePageDisplay();
                surveyAnswers = {};
                shuffledClothingSimulations = [];
                currentSimulationRoundIndex = 0;
                currentSimulationData = null;
            } catch (error) {
                console.error('送信エラー:', error);
                showModal('送信中にエラーが発生しました。', false);
            }
        }

        // --- Other checkbox helpers ---
        function isNoneCheckbox(cb) {
            if (!cb) return false;
            const NONE_KEYWORDS = ['なし','支援なし','受け取っていない','教わってない','教わっていない','ない','none'];
            const v = String(cb.value || '').toLowerCase();
            for (const kw of NONE_KEYWORDS) if (v.includes(kw)) return true;
            const id = String(cb.id || '').toLowerCase();
            for (const kw of NONE_KEYWORDS) if (id.includes(kw)) return true;
            if (cb.id) {
                const lab = document.querySelector(`label[for="${cb.id}"]`);
                if (lab) {
                    const text = (lab.textContent || '').toLowerCase();
                    for (const kw of NONE_KEYWORDS) if (text.includes(kw)) return true;
                }
            }
            return false;
        }

        function setupOtherCheckboxes() {
          document.querySelectorAll('input[type="checkbox"][data-has-other="true"]').forEach(cb => {
            const otherTargetId = cb.dataset.otherTarget;
            if (!otherTargetId) return;
            const containerId = cb.dataset.otherContainer || (otherTargetId + '_container');
            const container = document.getElementById(containerId);
            const textInput = document.getElementById(otherTargetId);
            if (cb.checked) {
              if (container) container.classList.remove('hidden');
              if (textInput) textInput.required = true;
            } else {
              if (container) container.classList.add('hidden');
              if (textInput) textInput.required = false;
            }
            cb.addEventListener('change', () => {
              if (cb.checked) {
                if (container) container.classList.remove('hidden');
                if (textInput) { textInput.required = true; textInput.focus(); }
              } else {
                if (container) container.classList.add('hidden');
                if (textInput) { textInput.required = false; textInput.value = ''; }
              }
            });
          });
        }

        // None-exclusive logic for checkboxes
        function setupNoneExclusive() {
          document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
            cb.addEventListener('change', (e) => {
              const target = e.target;
              const groupName = target.name;
              if (!groupName) return;
              const group = Array.from(document.querySelectorAll(`input[type="checkbox"][name="${groupName}"]`));
              const targetIsNone = isNoneCheckbox(target);
              if (targetIsNone && target.checked) group.forEach(cb2 => { if (cb2 !== target) cb2.checked = false; });
              else if (!targetIsNone && target.checked) group.forEach(cb2 => { if (isNoneCheckbox(cb2)) cb2.checked = false; });
            });
          });
        }

        // init
        document.addEventListener('DOMContentLoaded', () => {
            form.noValidate = true;
            form.addEventListener('submit', submitForm);
            setupOtherCheckboxes();
            setupNoneExclusive();
            updatePageDisplay();
        });

        window.addEventListener('orientationchange', () => setTimeout(checkOrientationRequirement,300));
        window.addEventListener('resize', () => setTimeout(checkOrientationRequirement,150));
    </script>
</body>
</html>
