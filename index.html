<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>衣服の購買における金銭感覚の調査</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #f3f4f6; /* 薄いグレーの背景 */
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            padding: 1rem;
            box-sizing: border-box;
            overflow-x: hidden; /* 横スクロールを防ぐ */
        }

        /* 縦向きの場合のスタイル */
        @media screen and (orientation: portrait) {
            #orientation-message {
                display: flex; /* 縦向きの時のみ表示 */
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0, 0, 0, 0.9); /* 暗いオーバーレイ */
                color: white;
                font-size: 1.5rem;
                font-weight: bold;
                justify-content: center;
                align-items: center;
                text-align: center;
                z-index: 1000; /* 最前面に表示 */
                padding: 1rem;
            }
            #survey-container {
                display: none; /* 縦向きの時はアンケートを非表示 */
            }
        }

        /* 横向きの場合のスタイル */
        @media screen and (orientation: landscape) {
            #orientation-message {
                display: none; /* 横向きの時は非表示 */
            }
            #survey-container {
                display: block; /* 横向きの時はアンケートを表示 */
                max-width: 800px;
                width: 100%;
            }
        }

        /* カスタムモーダル */
        .modal {
            display: none; /* デフォルトで非表示 */
            position: fixed;
            z-index: 1001; /* オーバーレイより上 */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4); /* 半透明の黒背景 */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #ffffff;
            margin: auto;
            padding: 2rem;
            border-radius: 0.75rem; /* rounded-lg */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* shadow-lg */
            text-align: center;
            max-width: 90%;
            width: 400px;
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        /* ページ切り替えアニメーション */
        .survey-page {
            display: none; /* デフォルトでは全てのページを非表示 */
            opacity: 0;
            transition: opacity 0.5s ease-in-out;
        }
        .survey-page.active {
            display: block; /* アクティブなページのみ表示 */
            opacity: 1;
        }
    </style>
</head>
<body>

    <!-- 縦画面時のメッセージ -->
    <div id="orientation-message" class="hidden">
        <p>回答は<span class="text-yellow-400">横画面</span>で行ってください。<br>デバイスを回転させてください。</p>
    </div>

    <!-- アンケートコンテナ -->
    <div id="survey-container" class="bg-white p-8 rounded-lg shadow-xl border border-gray-200">
        <!-- メインタイトル（表紙ページでのみ表示） -->
        <h1 id="main-survey-title" class="text-4xl font-extrabold text-gray-900 mb-8 text-center">衣服の購買における金銭感覚の調査</h1>
        
        <form id="survey-form" class="space-y-6">

            <!-- ページ0: 表紙ページ -->
            <div class="survey-page active" data-page="0">
                <p class="text-gray-700 text-lg mb-10 text-center">
                    本調査にご協力いただきありがとうございます。<br>
                    衣服の購買に関するあなたの金銭感覚についてお伺いします。<br>
                    ご回答いただいた内容は統計的に処理され、<br>
                    個人が特定できる形で公開されることは一切ございません。<br>
                    また、本調査の目的以外で利用することもございませんので、ご安心ください。<br>
                </p>
                <div class="flex justify-center mt-12">
                    <button type="button" onclick="nextPage()" class="py-3 px-10 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        次へ
                    </button>
                </div>
            </div>

            <!-- ページ1: 宣言と同意 -->
            <div class="survey-page" data-page="1">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">宣言と同意</h2>
                <p class="text-gray-700 mb-8">
                    <br>
                    私は前ページの内容を確認しました。<br>
                    また、私は以下の質問をきちんと読んで、まじめに回答します。
                </p>
                <div class="mb-6">
                    <div class="flex items-center">
                        <input id="declaration-and-agreemant" name="宣言と同意" type="radio" value="はい" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                        <label for="declaration-and-agreemant" class="ml-3 block text-sm text-gray-700">はい</label>
                    </div>
                </div>
                <div class="flex justify-between mt-6">
                    <button type="button" onclick="prevPage()" class="py-2 px-6 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        戻る
                    </button>
                    <button type="button" onclick="nextPage()" class="py-2 px-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        アンケートを開始
                    </button>
                </div>
            </div>

            <!-- ページ2: 基本情報 -->
            <div class="survey-page" data-page="2">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">基本情報</h2>
                <!-- 質問1: ドロップダウン -->
                <div class="mb-6">
                    <label for="age" class="block text-sm font-medium text-gray-700 mb-1">年齢を入力してください（半角数字）</label>
                    <input type="text" id="age" name="年齢" class="mt-1 block w-full rounded-md border border-gray-400 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm">
                </div>
                <!-- 質問2: 年齢 -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">性別</label>
                    <div class="mt-2 space-y-2">
                        <div class="flex items-center">
                            <input id="gender-male" name="性別" type="radio" value="男性" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                            <label for="gender-male" class="ml-3 block text-sm text-gray-700">男性</label>
                        </div>
                        <div class="flex items-center">
                            <input id="gender-female" name="性別" type="radio" value="女性" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                            <label for="gender-female" class="ml-3 block text-sm text-gray-700">女性</label>
                        </div>
                        <div class="flex items-center">
                            <input id="gender-other" name="性別" type="radio" value="その他" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                            <label for="gender-other" class="ml-3 block text-sm text-gray-700">その他</label>
                        </div>
                    </div>
                </div>
                <!-- 質問3: ラジオボタン -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">所属</label>
                    <div class="mt-2 space-y-2">
                        <div class="flex items-center">
                            <input id="affiliation-univ" name="所属" type="radio" value="大学生（専門学生を含む）" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                            <label for="affiliation-univ" class="ml-3 block text-sm text-gray-700">大学生（専門学生を含む）</label>
                        </div>
                        <div class="flex items-center">
                            <input id="affiliation-grad" name="所属" type="radio" value="大学院生" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                            <label for="affiliation-grad" class="ml-3 block text-sm text-gray-700">大学院生</label>
                        </div>
                        <div class="flex items-center">
                            <input id="affiliation-other" name="所属" type="radio" value="大学生ではない" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                            <label for="affiliation-other" class="ml-3 block text-sm text-gray-700">大学生ではない</label>
                        </div>
                    </div>
                </div>
                
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="nextPage()" class="py-2 px-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        次へ
                    </button>
                </div>
            </div>

            <!-- ページ3: 衣服の購買頻度などの質問 -->
            <div class="survey-page" data-page="3">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">衣服の購買頻度などの質問</h2>
                <!-- 質問: 購買頻度 -->
                <div class="mb-6">
                    <label for="purchase-frequency" class="block text-sm font-medium text-gray-700 mb-1">購買頻度（年平均）</label>
                    <select id="purchase-frequency" name="購買頻度" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <option value="">選択してください</option>
                        <option value="1ヶ月に1回より多い">1ヶ月に1回より多い</option>
                        <option value="1ヶ月に1回程度">1ヶ月に1回程度</option>
                        <option value="2ヶ月に1回程度">2ヶ月に1回程度</option>
                        <option value="3ヶ月に1回程度">3ヶ月に1回程度</option>
                        <option value="4か月に1回程度かそれ以下">4か月に1回程度かそれ以下</option>
                    </select>
                </div>
                <!-- 質問: 一度に使う金額 -->
                <div class="mb-6">
                    <label for="single-purchase-amount" class="block text-sm font-medium text-gray-700 mb-1">一度に使う金額</label>
                    <select id="single-purchase-amount" name="一度に使う金額" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <option value="">選択してください</option>
                        <option value="3000円以内">3000円以内</option>
                        <option value="3001～4000円">3001～4000円</option>
                        <option value="4001～5000円">4001～5000円</option>
                        <option value="5001～6000円">5001～6000円</option>
                        <option value="6001～7000円">6001～7000円</option>
                        <option value="7001～8000円">7001～8000円</option>
                        <option value="8001～9000円">8001～9000円</option>
                        <option value="9001～10000円">9001～10000円</option>
                        <option value="1万円以上">1万円以上</option>
                    </select>
                </div>
                <!-- 質問: 1ヶ月の使用金額（平均） -->
                <div class="mb-6">
                    <label for="monthly-spending" class="block text-sm font-medium text-gray-700 mb-1">1ヶ月の使用金額（平均）</label>
                    <select id="monthly-spending" name="1ヶ月の使用金額（平均）" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <option value="">選択してください</option>
                        <option value="3000円以内">3000円以内</option>
                        <option value="3001～4000円">3001～4000円</option>
                        <option value="4001～5000円">4001～5000円</option>
                        <option value="5001～6000円">5001～6000円</option>
                        <option value="6001～7000円">6001～7000円</option>
                        <option value="7001～8000円">7001～8000円</option>
                        <option value="8001～9000円">8001～9000円</option>
                        <option value="9001～10000円">9001～10000円</option>
                        <option value="1万円以上">1万円以上</option>
                    </select>
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="nextPageConditional()" class="py-2 px-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        次へ
                    </button>
                </div>
            </div>

            <!-- ページ4: 所属世帯について -->
            <div class="survey-page" data-page="4">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">所属世帯について</h2>
                <!-- 質問: 所属世帯について (条件分岐のトリガー) -->
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">所属世帯について</label>
                    <div class="mt-2 space-y-2">
                        <div class="flex items-center">
                            <input id="household-live-with-parents" name="所属世帯" type="radio" value="実家暮らし" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                            <label for="household-live-with-parents" class="mt-1 block text-sm text-gray-700">実家暮らし</label>
                        </div>
                        <div class="flex items-center">
                            <input id="household-live-alone-hs" name="所属世帯" type="radio" value="高校生から一人暮らし" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                            <label for="household-live-alone-hs" class="mt-1 block text-sm text-gray-700">高校生から一人暮らし</label>
                        </div>
                        <div class="flex items-center">
                            <input id="household-live-alone-univ" name="所属世帯" type="radio" value="大学生から一人暮らし" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                            <label for="household-live-alone-univ" class="mt-1 block text-sm text-gray-700">大学生から一人暮らし</label>
                        </div>
                        <div class="flex items-center">
                            <input id="household-live-alone-grad" name="所属世帯" type="radio" value="大学院生から一人暮らし" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                            <label for="household-live-alone-grad" class="mt-1 block text-sm text-gray-700">大学院生から一人暮らし</label>
                        </div>
                        <div class="flex items-center">
                            <input id="household-live-alone-work" name="所属世帯" type="radio" value="就職から一人暮らし" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                            <label for="household-live-alone-work" class="mt-1 block text-sm text-gray-700">就職から一人暮らし</label>
                        </div>
                        <div class="flex items-center">
                            <input id="household-returned-home" name="所属世帯" type="radio" value="一人暮らしから実家暮らしに戻っている" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                            <label for="household-returned-home" class="mt-1 block text-sm text-gray-700">一人暮らしから実家暮らしに戻っている</label>
                        </div>
                    </div>
                </div>

                <div class="flex justify-end mt-6">
                    <button type="button" onclick="nextPageConditional()" class="py-2 px-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        次へ
                    </button>
                </div>
            </div>

            <!-- ページ5: 実家暮らし選択時のページ -->
            <div class="survey-page" data-page="5">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">実家暮らしの方への質問</h2>
                <div class="mb-8">
                    <label class="block text-sm font-medium text-gray-700 mb-2">家庭にお金を入れている</label>
                    <div class="mt-2 space-y-2">
                        <div class="flex items-center">
                            <input id="household-contribute-yes" name="家庭にお金を入れている" type="radio" value="はい" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                            <label for="household-contribute-yes" class="mt-1 block text-sm text-gray-700">はい</label>
                        </div>
                        <div class="flex items-center">
                            <input id="household-contribute-no" name="家庭にお金を入れている" type="radio" value="いいえ" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                            <label for="household-contribute-no" class="mt-1 block text-sm text-gray-700">いいえ</label>
                        </div>
                    </div>
                </div>
                <!-- 質問間の区切り線 -->
                <div class="border-b border-gray-300 my-6 w-full"></div>

                <div class="mb-8">
                    <label class="block text-sm font-medium text-gray-700 mb-2">奨学金を受け取っている</label>
                    <div class="mt-2 space-y-2">
                        <div class="flex items-center">
                            <input id="scholarship-received-yes-home" name="奨学金" type="radio" value="はい" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                            <label for="scholarship-received-yes-home" class="mt-1 block text-sm text-gray-700">はい</label>
                        </div>
                        <div class="flex items-center">
                            <input id="scholarship-received-no-home" name="奨学金" type="radio" value="いいえ" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                            <label for="scholarship-received-no-home" class="mt-1 block text-sm text-gray-700">いいえ</label>
                        </div>
                    </div>
                </div>
                <!-- 質問間の区切り線 -->
                <div class="border-b border-gray-300 my-6 w-full"></div>

                <div class="mb-8">
                    <label for="part-time-income-home" class="block text-sm font-medium text-gray-700 mb-1">アルバイトの収入</label>
                    <select id="part-time-income-home" name="アルバイトの収入" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <option value="">選択してください</option>
                        <option value="月5万円未満">月5万円未満</option>
                        <option value="月5～6万円">月5～6万円</option>
                        <option value="月6～7万円">月6～7万円</option>
                        <option value="月7～8万円">月7～8万円</option>
                        <option value="月8万円以上">月8万円以上</option>
                        <option value="アルバイトをしていない">アルバイトをしていない</option>
                        <option value="就職している">就職している</option>
                    </select>
                </div>
                
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="nextPageConditional()" class="py-2 px-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        次へ
                    </button>
                </div>
            </div>

            <!-- ページ6: 一人暮らし選択時のページ -->
            <div class="survey-page" data-page="6">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">一人暮らしの方への質問</h2>
                <div class="mb-8">
                    <label class="block text-sm font-medium text-gray-700 mb-2">家賃補助を実家から受け取っている</label>
                    <div class="mt-2 space-y-2">
                        <div class="flex items-center">
                            <input id="rent-subsidy-yes-alone" name="家賃補助" type="radio" value="はい" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                            <label for="rent-subsidy-yes-alone" class="mt-1 block text-sm text-gray-700">はい</label>
                        </div>
                        <div class="flex items-center">
                            <input id="rent-subsidy-no-alone" name="家賃補助" type="radio" value="いいえ" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                            <label for="rent-subsidy-no-alone" class="mt-1 block text-sm text-gray-700">いいえ</label>
                        </div>
                    </div>
                </div>
                <!-- 質問間の区切り線 -->
                <div class="border-b border-gray-300 my-6 w-full"></div>

                <div class="mb-8">
                    <label class="block text-sm font-medium text-gray-700 mb-2">奨学金を受け取っている</label>
                    <div class="mt-2 space-y-2">
                        <div class="flex items-center">
                            <input id="scholarship-received-yes-alone" name="奨学金" type="radio" value="はい" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                            <label for="scholarship-received-yes-alone" class="mt-1 block text-sm text-gray-700">はい</label>
                        </div>
                        <div class="flex items-center">
                            <input id="scholarship-received-no-alone" name="奨学金" type="radio" value="いいえ" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                            <label for="scholarship-received-no-alone" class="mt-1 block text-sm text-gray-700">いいえ</label>
                        </div>
                    </div>
                </div>
                <!-- 質問間の区切り線 -->
                <div class="border-b border-gray-300 my-6 w-full"></div>

                <div class="mb-8">
                    <label for="part-time-income-alone" class="block text-sm font-medium text-gray-700 mb-1">アルバイトの収入</label>
                    <select id="part-time-income-alone" name="アルバイトの収入" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md shadow-sm">
                        <option value="">選択してください</option>
                        <option value="月5万円未満">月5万円未満</option>
                        <option value="月5～6万円">月5～6万円</option>
                        <option value="月6～7万円">月6～7万円</option>
                        <option value="月7～8万円">月7～8万円</option>
                        <option value="月8万円以上">月8万円以上</option>
                        <option value="アルバイトをしていない">アルバイトをしていない</option>
                        <option value="就職している">就職している</option>
                    </select>
                </div>
                
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="nextPageConditional()" class="py-2 px-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        次へ
                    </button>
                </div>
            </div>

            <div class="survey-page" data-page="7">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">次のセクションについて</h2>
                <p class="text-gray-700 mb-10">
                    <!-- 質問の説明 -->
                    次のセクションでは、<br>
                    あなたの幼少期から現在における「家庭の環境やお金の教育」についてお聞きします。<br>
                    「まったくあてはまらない～とてもあてはまる」の<br>
                    5つの選択肢から該当するものを選択してください。
                </p>
                <div class="mb-6">
                    <div class="flex items-center">
                        <input id="illustration" name="質問の説明" type="radio" value="確認しました" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                        <label for="illustration" class="ml-3 block text-sm text-gray-700">確認しました</label>
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="nextPage()" class="py-2 px-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        次へ
                    </button>
                </div>
            </div>

            <!-- ページ7: 家庭についての質問 (ランダム表示用コンテナ) -->
            <div class="survey-page" data-page="8">
                <div id="random-question-content" class="text-center">
                    <!-- ランダムな質問がここに挿入されます -->
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="nextPage()" class="py-2 px-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        次へ
                    </button>
                </div>
            </div>

            <!-- ページ8: 衣服の購買シミュレーション説明 -->
            <div class="survey-page" data-page="9">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4">衣服の購買シミュレーション説明</h2>
                <p class="text-gray-700 mb-8">
                    これから衣服の画像と価格、その他の情報が表示されます。<br>
                    あなたは、その衣服を「買う」か「買わない」かを選択してください。<br>
                    ※選択後すぐに、新しい情報へ更新されるため、ボタンを連打しないよう注意してください。
                </p>
                <div class="mb-6">
                    <div class="flex items-center">
                        <input id="confirmation" name="シミュレーション説明確認" type="radio" value="確認しました" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                        <label for="confirmation" class="ml-3 block text-sm text-gray-700">確認しました</label>
                    </div>
                </div>
                <div class="flex justify-end mt-6">
                    <button type="button" onclick="nextPageConditional()" class="py-2 px-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        次へ
                    </button>
                </div>
            </div>

            <!-- ページ9: 衣服の購買シミュレーション -->
            <div class="survey-page" data-page="10">
                <div class="flex flex-col items-center justify-center p-4 bg-gray-50 rounded-lg shadow-inner mb-6">
                    <img id="clothing-image" src="https://github.com/researchforme/my_survey_img/blob/main/%E3%82%B8%E3%83%A3%E3%82%B1%E3%83%83%E3%83%88.png?raw=true" alt="Clothing Item" class="rounded-md shadow-md mb-4">
                    <p class="text-xl font-medium text-gray-700 mb-2">種類: <span id="clothing-item-type" class="font-semibold text-gray-900"></span></p>
                    <p class="text-xl font-medium text-gray-700 mb-2">すでに持っている服との組み合わせ: <span id="clothing-combination" class="font-semibold text-gray-900"></span></p>
                    <p class="text-xl font-medium text-gray-700 mb-4">利用場面: <span id="clothing-situation" class="font-semibold text-gray-900"></span></p>
                    <p class="text-2xl font-bold text-gray-900 mb-6">価格: <span id="current-price"></span>円</p>
                    <div class="flex space-x-4">
                        <button type="button" id="buy-button" onclick="handlePurchaseChoice('buy')" class="py-3 px-8 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 transition duration-150 ease-in-out">
                            買う
                        </button>
                        <button type="button" id="dont-buy-button" onclick="handlePurchaseChoice('donotbuy')" class="py-3 px-8 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition duration-150 ease-in-out">
                            買わない
                        </button>
                    </div>
                    <!-- 次のシミュレーションへ進むボタン (非表示) -->
                    <button type="button" id="next-simulation-button" onclick="goToNextSimulation()" class="py-3 px-10 border border-transparent rounded-md shadow-sm text-lg font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out mt-6 hidden">
                        次へ進む
                    </button>
                </div>
                <!-- ページ9には回答送信ボタンは表示しない -->
            </div>

            <!-- ページ10: 回答完了画面 -->
            <div class="survey-page" data-page="11">
                <h2 class="text-2xl font-semibold text-gray-800 mb-6 text-center">調査完了</h2>
                <p class="text-gray-700 mb-8 text-center text-xl font-bold">
                    調査は以上です。<br>
                    「回答を送信」を押してください。</p>
                <div class="flex justify-center mt-6">
                    <button type="submit" id="submit-button-final" class="py-2 px-6 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-150 ease-in-out">
                        回答を送信
                    </button>
                </div>
            </div>

        </form>
    </div>

    <!-- ローディングとメッセージ表示用のモーダル -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <p id="modal-message" class="text-lg font-semibold text-gray-800"></p>
            <div id="loading-spinner" class="hidden mt-4">
                <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
            </div>
            <button id="modal-close-button" class="mt-6 py-2 px-4 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition duration-150 ease-in-out hidden">
                閉じる
            </button>
        </div>
    </div>

    <script>
        // Google Apps ScriptのWebアプリのURLをここに設定します
        // デプロイ後にGoogle Apps Scriptから取得したURLに置き換えてください
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx-eu-h9B5aFMiPpR2nOGF1gOUVc-IqPHlFUp0qJyFuuVcr7WjQCh-A5QySKPc35c94/exec'; 

        const form = document.getElementById('survey-form');
        const surveyPages = document.querySelectorAll('.survey-page');
        const mainSurveyTitle = document.getElementById('main-survey-title'); // メインタイトル要素
        const statusModal = document.getElementById('statusModal');
        const modalMessage = document.getElementById('modal-message');
        const loadingSpinner = document.getElementById('loading-spinner');
        const modalCloseButton = document.getElementById('modal-close-button');

        // シミュレーション関連の要素
        const currentPriceSpan = document.getElementById('current-price');
        const buyButton = document.getElementById('buy-button');
        const dontBuyButton = document.getElementById('dont-buy-button');
        const submitButtonFinal = document.getElementById('submit-button-final'); // ページ10の最終送信ボタン
        const clothingImage = document.getElementById('clothing-image'); // 画像要素
        const clothingItemTypeSpan = document.getElementById('clothing-item-type'); // 衣服の種類表示要素を新しく追加
        const clothingCombinationSpan = document.getElementById('clothing-combination'); // デザイン表示要素
        const clothingSituationSpan = document.getElementById('clothing-situation');   // ブランド表示要素
        const nextSimulationButton = document.getElementById('next-simulation-button'); // 次のシミュレーションボタン

        // 衣服の画像URLリスト (ベース画像)
        // **ここにあなたの画像URLを挿入してください**
        const formalJacketUrl = "https://github.com/researchforme/my_survey_img/blob/main/%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%AB%E3%81%AA%E3%82%B8%E3%83%A3%E3%82%B1%E3%83%83%E3%83%88.png?raw=true"; // フォーマルなジャケットのURL
        const casualJacketUrl = "https://github.com/researchforme/my_survey_img/blob/main/%E3%82%AB%E3%82%B8%E3%83%A5%E3%82%A2%E3%83%AB%E3%81%AA%E3%82%B8%E3%83%A3%E3%82%B1%E3%83%83%E3%83%88.png?raw=true"; // カジュアルなジャケットのURL

        // 全8種類の購買シミュレーションデータ
        const allClothingSimulationsData = [
            { id: "sim_formal_good_lunch", imageUrl: formalJacketUrl, itemType: "フォーマルなジャケット", combination: "良い", situation: "友人と食事" },
            { id: "sim_formal_good_date", imageUrl: formalJacketUrl, itemType: "フォーマルなジャケット", combination: "良い", situation: "デート" },
            { id: "sim_formal_bad_lunch", imageUrl: formalJacketUrl, itemType: "フォーマルなジャケット", combination: "悪い", situation: "友人と食事" },
            { id: "sim_formal_bad_date", imageUrl: formalJacketUrl, itemType: "フォーマルなジャケット", combination: "悪い", situation: "デート" },
            { id: "sim_casual_good_lunch", imageUrl: casualJacketUrl, itemType: "カジュアルなジャケット", combination: "良い", situation: "友人と食事" },
            { id: "sim_casual_good_date", imageUrl: casualJacketUrl, itemType: "カジュアルなジャケット", combination: "良い", situation: "デート" },
            { id: "sim_casual_bad_lunch", imageUrl: casualJacketUrl, itemType: "カジュアルなジャケット", combination: "悪い", situation: "友人と食事" },
            { id: "sim_casual_bad_date", imageUrl: casualJacketUrl, itemType: "カジュアルなジャケット", combination: "悪い", situation: "デート" },
        ];
        
        // ランダム化する家庭についての質問データ
        const familyQuestionsData = [
            {
                title: "自分の実家は裕福だと感じる",
                name: "裕福",
                options: [
                    "まったくあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてはまる"
                ]
            },
            {
                title: "自分の実家は貧しいと感じる",
                name: "貧しい",
                options: [
                    "まったくあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてはまる"
                ]
            },
            {
                title: "育ての親は倹約家である",
                name: "親は倹約",
                options: [
                    "まったくあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてはまる"
                ]
            },
            {
                title: "育ての親はファッションに関心があった",
                name: "親ファッション",
                options: [
                    "まったくあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてはまる"
                ]
            },
            {
                title: "子供のころお金を貯金するように教えられた",
                name: "貯金",
                options: [
                    "まったくあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてはまる"
                ]
            },
            {
                title: "子供のころお金を上手く活用するように教えられた",
                name: "活用",
                options: [
                    "まったくあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてはまる"
                ]
            },
            {
                title: "子供のころ欲しいものは何でも買ってもらえた",
                name: "欲しいものは何でも",
                options: [
                    "まったくあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてはまる"
                ]
            },
            {
                title: "子供のころ欲しいものを買ってもらうにはルールがあった<br>（良い成績を取る、お手伝いをするなど）",
                name: "ルール",
                options: [
                    "まったくあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてはまる"
                ]
            },
            {
                title: "子供のころ理由があれば欲しいものを買ってもらえた",
                name: "理由",
                options: [
                    "まったくあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてはまる"
                ]
            },
            {
                title: "子供のころ自分のお小遣いで買ったものが不要なものだと言われた",
                name: "不要",
                options: [
                    "まったくあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてはまる"
                ]
            },
            {
                title: "「あてはまる」を選択してください",
                name: "トラップ2",
                options: [
                    "まったくあてはまらない", "あてはまらない", "どちらともいえない", "あてはまる", "とてもあてはまる"
                    ]
            }

        ];

        let shuffledClothingSimulations = []; // ランダム化されたシミュレーション順序
        let currentSimulationRoundIndex = 0; // 現在のシミュレーションのラウンド (0から始まり、全シミュレーション数-1まで)
        let currentSimulationData = null; // 現在のシミュレーションのデータオブジェクト

        let currentPageIndex = 0; // 現在表示されているページのインデックス (0始まり)
        let clothingPrice = 1000; // 衣服の初期価格
        let isPriceAt500Mark = false; // 百の位が5の価格に達しているかどうかのフラグ
        let lastRecordedChoice = ''; // シミュレーションの最後に記録された選択 (買う/買わない)
        let surveyAnswers = {}; // 全てのアンケート回答を保存するオブジェクト

        let shuffledFamilyQuestionIndices = []; // ランダム化された質問の順序を格納
        let currentFamilyQuestionIndexInShuffledOrder = 0; // ランダム化された質問ブロック内の現在の質問インデックス

        const randomQuestionContainer = document.getElementById('random-question-content');

        // Fisher-Yates シャッフルアルゴリズム
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        // ページを更新して表示する関数
        function updatePageDisplay() {
            surveyPages.forEach((page, index) => {
                if (index === currentPageIndex) {
                    page.classList.add('active'); // アクティブなページを表示
                } else {
                    page.classList.remove('active'); // それ以外のページを非表示
                }
            });

            // メインタイトルは表紙ページ (index 0) でのみ表示
            if (currentPageIndex === 0) {
                mainSurveyTitle.classList.remove('hidden');
            } else {
                mainSurveyTitle.classList.add('hidden');
            }

            // 家庭についての質問ページ (data-page="7") の特殊処理
            if (currentPageIndex === 8) {
                // 初めてこのセクションに入る場合、または前回のセッションから再開する場合
                if (shuffledFamilyQuestionIndices.length === 0 || currentFamilyQuestionIndexInShuffledOrder >= familyQuestionsData.length) {
                    shuffledFamilyQuestionIndices = Array.from({ length: familyQuestionsData.length }, (_, i) => i);
                    shuffleArray(shuffledFamilyQuestionIndices);
                    currentFamilyQuestionIndexInShuffledOrder = 0;
                }

                const originalQuestionIndex = shuffledFamilyQuestionIndices[currentFamilyQuestionIndexInShuffledOrder];
                const questionData = familyQuestionsData[originalQuestionIndex];
                
                // 質問のHTMLを動的に生成して挿入
                randomQuestionContainer.innerHTML = `
                    <h2 class="text-2xl font-semibold text-gray-800 mb-6">${questionData.title}</h2>
                    <div class="mb-10">
                        <div class="mt-2 flex flex-wrap gap-x-6 gap-y-4 justify-center">
                            ${questionData.options.map((option, idx) => `
                                <div class="flex flex-col items-center">
                                    <input id="${questionData.name}-${idx}" name="${questionData.name}_${originalQuestionIndex}" type="radio" value="${option}" class="focus:ring-indigo-500 h-4 w-4 text-indigo-600 border-gray-300 rounded-full">
                                    <label for="${questionData.name}-${idx}" class="mt-1 block text-sm text-gray-700">${option}</label>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                // 以前に選択された回答があれば復元
                const storedAnswerKey = `${questionData.name}_${originalQuestionIndex}`;
                if (surveyAnswers[storedAnswerKey]) {
                    const radio = randomQuestionContainer.querySelector(`input[name="${storedAnswerKey}"][value="${surveyAnswers[storedAnswerKey]}"]`);
                    if (radio) {
                        radio.checked = true;
                    }
                }
            } else {
                // 家庭についての質問ページ以外では内容をクリア
                if (randomQuestionContainer) {
                    randomQuestionContainer.innerHTML = '';
                }
            }

            window.scrollTo(0, 0); // ページ上部にスクロール

            // ページ9に移動した際にシミュレーションを開始 (インデックスは9)
            if (currentPageIndex === 10) { 
                startClothingPurchaseSimulation();
            }
        }

        // 次のページへ進む関数 (一般的な遷移)
        function nextPage() {
            // ページ1: 宣言と同意 のラジオボタンの選択をチェック
            if (currentPageIndex === 1) {
                const agreementRadio = document.querySelector('input[name="宣言と同意"]:checked');
                // ラジオボタンが選択されていない場合
                if (!agreementRadio) {
                    showModal('「はい」を選択してください。', false); // モーダルでエラーメッセージを表示
                    return; // ページ遷移を中止
                }
            }

            // ページ2：回答させる
            if (currentPageIndex === 2) {
                const genderRadio = document.querySelector('input[name="性別"]:checked');
                const affiliationRadio = document.querySelector('input[name="所属"]:checked');
                // ラジオボタンが選択されていない場合
                if (!genderRadio || !affiliationRadio) {
                    showModal('すべての質問に回答してください', false); // モーダルでエラーメッセージを表示
                    return; // ページ遷移を中止
                }
            }

            if (currentPageIndex === 7) {
                const agreementRadio = document.querySelector('input[name="質問の説明"]:checked');
                // ラジオボタンが選択されていない場合
                if (!agreementRadio) {
                    showModal('「確認しました」を選択してください。', false); // モーダルでエラーメッセージを表示
                    return; // ページ遷移を中止
                }
            }

            // ページ7: 家庭についての質問 (ランダム化された質問) の選択をチェック
            if (currentPageIndex === 8) {
                const originalQuestionIndex = shuffledFamilyQuestionIndices[currentFamilyQuestionIndexInShuffledOrder];
                const questionData = familyQuestionsData[originalQuestionIndex];
                // 現在表示されている質問のラジオボタンが選択されているかを確認
                const selectedAnswer = document.querySelector(`input[name="${questionData.name}_${originalQuestionIndex}"]:checked`);
                
                // 回答が選択されていない場合はエラーメッセージを表示し、遷移を阻止
                if (!selectedAnswer) {
                    showModal('選択肢を選んでください。', false); // モーダルでエラーメッセージを表示
                    return; // ページ遷移を中止
                }
                // 回答を保存
                surveyAnswers[`${questionData.name}_${originalQuestionIndex}`] = selectedAnswer.value;

                // 次のランダム質問へ、または次のセクションへ遷移
                if (currentFamilyQuestionIndexInShuffledOrder < familyQuestionsData.length - 1) {
                    currentFamilyQuestionIndexInShuffledOrder++;
                } else {
                    // 全てのランダム質問が完了したら、次のメインセクションへ
                    currentPageIndex = 9; // シミュレーション説明ページへ
                    // ランダム質問関連のインデックスをリセット
                    shuffledFamilyQuestionIndices = [];
                    currentFamilyQuestionIndexInShuffledOrder = 0;
                }
            } 
            // 上記以外のページは単純に次へ
            // ただし、nextPageConditional()が呼ばれるページは除く (ページ4, 5, 6, 8)
            else if (currentPageIndex !== 4 && currentPageIndex !== 5 && currentPageIndex !== 6 && currentPageIndex !== 9) { 
                currentPageIndex++;
            }
            updatePageDisplay();
        }

        // 条件分岐を含む次のページへ進む関数
        function nextPageConditional() {
            // ページ2：回答させる
            if (currentPageIndex === 2) {
                const age = document.getElementById('age').value;

                if (age === "") {
                    showModal('すべての質問に回答してください。', false);
                    return; // ページ遷移を中止
                }
                // 回答を保存
                surveyAnswers['年齢'] = age;

                currentPageIndex++; // すべて回答されていれば次のページへ
            }
            // ページ3: 衣服の購買頻度などの質問 の選択をチェック
            else if (currentPageIndex === 3) {
                const purchaseFrequency = document.getElementById('purchase-frequency').value;
                const singlePurchaseAmount = document.getElementById('single-purchase-amount').value;
                const monthlySpending = document.getElementById('monthly-spending').value;

                if (purchaseFrequency === "" || singlePurchaseAmount === "" || monthlySpending === "") {
                    showModal('すべての質問に回答してください。', false);
                    return; // ページ遷移を中止
                }
                // 回答を保存
                surveyAnswers['購買頻度'] = purchaseFrequency;
                surveyAnswers['一度に使う金額'] = singlePurchaseAmount;
                surveyAnswers['1ヶ月の使用金額（平均）'] = monthlySpending;

                currentPageIndex++; // すべて回答されていれば次のページへ
            }
            // ページ4: 所属世帯について のロジック
            else if (currentPageIndex === 4) {
                const selectedHouseholdType = document.querySelector('input[name="所属世帯"]:checked');
                
                if (!selectedHouseholdType) {
                    showModal('所属世帯を選択してください。', false);
                    return;
                }

                // 回答を保存
                surveyAnswers['所属世帯'] = selectedHouseholdType.value;

                const isAloneLiving = [
                    '高校生から一人暮らし',
                    '大学生から一人暮らし',
                    '大学院生から一人暮らし',
                    '就職から一人暮らし'
                ].includes(selectedHouseholdType.value);

                if (isAloneLiving) {
                    currentPageIndex = 6; // 一人暮らしの方への質問 (ページ6)
                } else {
                    currentPageIndex = 5; // 実家暮らしの方への質問 (ページ5)
                }
            } 
            // 実家暮らしまたは一人暮らしの質問の後の遷移 (ページ5またはページ6から家庭についての質問の最初のページ7へ)
            else if (currentPageIndex === 5) {
                // ページ5の回答を保存
                const householdContribute = document.querySelector('input[name="家庭にお金を入れている"]:checked');
                const scholarshipReceived = document.querySelector('input[name="奨学金"]:checked');
                const partTimeIncome = document.getElementById('part-time-income-home');

                if (!householdContribute || !scholarshipReceived || partTimeIncome.value === "") {
                    showModal('全ての質問に回答してください。', false);
                    return;
                }
                surveyAnswers['家庭にお金を入れている'] = householdContribute.value;
                surveyAnswers['奨学金'] = scholarshipReceived.value;
                surveyAnswers['アルバイトの収入'] = partTimeIncome.value;
                currentPageIndex = 7; 
            }
            else if (currentPageIndex === 6) {
                // ページ6の回答を保存
                const rentSubsidy = document.querySelector('input[name="家賃補助"]:checked');
                const scholarshipReceivedAlone = document.querySelector('input[name="奨学金"]:checked');
                const partTimeIncomeAlone = document.getElementById('part-time-income-alone');

                if (!rentSubsidy || !scholarshipReceivedAlone || partTimeIncomeAlone.value === "") {
                    showModal('全ての質問に回答してください。', false);
                    return;
                }
                surveyAnswers['家賃補助'] = rentSubsidy.value;
                surveyAnswers['奨学金'] = scholarshipReceivedAlone.value;
                surveyAnswers['アルバイトの収入'] = partTimeIncomeAlone.value;
                currentPageIndex = 7; 
            }
            // ページ8: 衣服の購買シミュレーション説明 のラジオボタンの選択をチェック
            else if (currentPageIndex === 9) {
                const confirmationRadio = document.querySelector('input[name="シミュレーション説明確認"]:checked'); // name属性を修正
                // ラジオボタンが選択されていない場合
                if (!confirmationRadio) {
                    showModal('「確認しました」を選択してください。', false); // モーダルでエラーメッセージを表示
                    return; // ページ遷移を中止
                }
                // 回答を保存
                surveyAnswers['シミュレーション説明確認'] = confirmationRadio.value; // シミュレーション説明の確認状態を保存

                // 確認済みであれば、シミュレーション本体ページへ遷移
                currentPageIndex = 10; 
            }
            updatePageDisplay();
        }

        // 前のページへ戻る関数
        function prevPage() {
            if (currentPageIndex > 0) {
                // 回答完了画面 (ページ10) からシミュレーション本体 (ページ9) へ
                if (currentPageIndex === 11) {
                    currentPageIndex = 10;
                }
                // シミュレーション本体 (ページ9) からシミュレーション説明 (ページ8) へ
                else if (currentPageIndex === 10) {
                    // もし現在アクティブなシミュレーションの最初のラウンドなら、ページ8に戻る
                    if (currentSimulationRoundIndex === 0) {
                        currentPageIndex = 9;
                        // シミュレーションデータをリセット
                        shuffledClothingSimulations = [];
                        currentSimulationRoundIndex = 0;
                        currentSimulationData = null;
                    } else {
                        // 途中のシミュレーションから戻る場合、前のシミュレーションラウンドに戻る
                        currentSimulationRoundIndex--;
                        startClothingPurchaseSimulation(); // 前のシミュレーションを再開
                        return; // ここで関数を終了し、updatePageDisplay()はstartClothingPurchaseSimulation()内で呼ばれる
                    }
                }
                // シミュレーション説明 (ページ8) から家庭についての質問の最後のページ (ページ7) へ
                else if (currentPageIndex === 9) {
                    currentPageIndex = 8;
                    currentFamilyQuestionIndexInShuffledOrder = familyQuestionsData.length - 1; // ランダム質問の最後の質問に戻る
                }
                // 家庭についての質問のランダム化されたページ内での戻る
                else if (currentPageIndex === 8) {
                    if (currentFamilyQuestionIndexInShuffledOrder > 0) {
                        currentFamilyQuestionIndexInShuffledOrder--;
                    } else {
                        // ランダム質問の最初の質問から戻る場合、所属世帯タイプに応じてページ5または6へ
                        const selectedHouseholdType = surveyAnswers['所属世帯']; // surveyAnswersから取得

                        if (selectedHouseholdType && [
                            '高校生から一人暮らし',
                            '大学生から一人暮らし',
                            '大学院生から一人暮らし',
                            '就職から一人暮らし'
                        ].includes(selectedHouseholdType)) {
                            currentPageIndex = 6; // 一人暮らしの方への質問 (ページ6)
                        } else {
                            currentPageIndex = 5; // 実家暮らしの方への質問 (ページ5)
                        }
                        // ランダム質問関連のインデックスをリセット
                        shuffledFamilyQuestionIndices = [];
                        currentFamilyQuestionIndexInShuffledOrder = 0;
                    }
                }
                // 実家暮らしまたは一人暮らしの質問ページ (ページ5またはページ6) から所属世帯 (ページ4) へ
                else if (currentPageIndex === 5 || currentPageIndex === 6) {
                    currentPageIndex = 4;
                }
                // その他のページは単純に前へ
                else {
                    currentPageIndex--;
                }
                updatePageDisplay();
            }
        }

        // シミュレーションを開始する関数
        function startClothingPurchaseSimulation() {
            // シミュレーションがまだシャッフルされていない、または全シミュレーションが完了している場合
            if (shuffledClothingSimulations.length === 0 || currentSimulationRoundIndex >= allClothingSimulationsData.length) {
                shuffledClothingSimulations = [...allClothingSimulationsData]; // 元のデータをコピー
                shuffleArray(shuffledClothingSimulations); // ランダムにシャッフル
                currentSimulationRoundIndex = 0; // 最初から開始
            }

            currentSimulationData = shuffledClothingSimulations[currentSimulationRoundIndex];

            clothingPrice = 1000; // 価格をリセット
            isPriceAt500Mark = false; // シミュレーション状態をリセット
            
            // UIを更新
            updateClothingPriceAndImage(); // 価格と画像、デザイン、ブランドを更新
            buyButton.disabled = false;
            dontBuyButton.disabled = false;
            nextSimulationButton.classList.add('hidden'); // 次へ進むボタンは非表示
            buyButton.classList.remove('hidden'); // 買うボタンを表示
            dontBuyButton.classList.remove('hidden'); // 買わないボタンを表示
        }

        // 価格表示、画像、デザイン、ブランド表示を更新する関数
        function updateClothingPriceAndImage() {
            currentPriceSpan.textContent = clothingPrice.toLocaleString();
            if (currentSimulationData) { // 現在のシミュレーションデータがあるか確認
                clothingImage.src = currentSimulationData.imageUrl;
                clothingItemTypeSpan.textContent = currentSimulationData.itemType; // 衣服の種類を設定
                clothingCombinationSpan.textContent = currentSimulationData.combination;
                clothingSituationSpan.textContent = currentSimulationData.situation;
                // 画像がロードできない場合のフォールバック
                clothingImage.onerror = () => {
                    clothingImage.src = "https://placehold.co/300x300/ff0000/ffffff?text=Error"; // エラー画像
                    clothingImage.alt = "Error loading image";
                };
            } else {
                // シミュレーションデータがない場合
                clothingImage.src = "https://placehold.co/300x300/e0e0e0/555555?text=No+Data";
                clothingImage.alt = "No simulation data";
                clothingItemTypeSpan.textContent = "N/A"; // 衣服の種類もN/Aに設定
                clothingCombinationSpan.textContent = "N/A";
                clothingSituationSpan.textContent = "N/A";
            }
        }

        // 購買選択を処理する関数
        function handlePurchaseChoice(choice) {
            // シミュレーションが終了すべきかどうかを、現在の選択を適用する前にチェック
            if (isPriceAt500Mark) {
                // もし価格がX500円のマークに達していた場合（この選択の直前）、
                // 今回のクリックが「最後にもう一度選択」となる
                const finalRecordedPrice = clothingPrice; // この時点で記録すべき価格（X500円）
                const finalChoiceText = (choice === 'buy') ? '買う' : '買わない';

                // ボタンを無効化
                buyButton.disabled = true;
                dontBuyButton.disabled = true;
                buyButton.classList.add('hidden'); // 買うボタンを非表示
                dontBuyButton.classList.add('hidden'); // 買わないボタンを非表示

                // 最終結果を surveyAnswers に追加 (シミュレーションIDを含める)
                // ここで「XXX円で買う/買わない」形式に統合
                surveyAnswers[`${currentSimulationData.id}_最終結果`] = `${finalRecordedPrice}円で${finalChoiceText}`; 

                // 次のシミュレーションがあるかチェック
                if (currentSimulationRoundIndex < allClothingSimulationsData.length - 1) {
                    // 次のシミュレーションへ進むボタンを表示
                    nextSimulationButton.classList.remove('hidden');
                } else {
                    // 全てのシミュレーションが完了したら、回答完了画面へ
                    currentPageIndex = 11; // 回答完了画面へ遷移
                    updatePageDisplay();
                }
                isPriceAt500Mark = false; // フラグをリセット
                return; // シミュレーション終了後、関数を抜ける
            }

            // シミュレーションが終了しない場合、価格変動を適用
            let choiceText = '';
            if (choice === 'buy') {
                clothingPrice += 1000;
                choiceText = '買う';
            } else if (choice === 'donotbuy') {
                clothingPrice -= 500;
                choiceText = '買わない';
            }
            lastRecordedChoice = choiceText; // 現在の選択を記録
            
            updateClothingPriceAndImage(); // 価格、画像、デザイン、ブランドを更新

            // 価格変動後、現在の価格の百の位が5かどうかをチェック
            // もし5であれば、次の選択が最終選択となるようフラグを設定
            const currentHundredsDigit = Math.floor(Math.abs(clothingPrice) / 100) % 10;
            if (currentHundredsDigit === 5) {
                isPriceAt500Mark = true; 
            } else {
                isPriceAt500Mark = false; // 5でなければフラグをリセット
            }
        }

        // 次のシミュレーションに進む関数
        function goToNextSimulation() {
            currentSimulationRoundIndex++; // 次のシミュレーションラウンドへ
            if (currentSimulationRoundIndex < allClothingSimulationsData.length) {
                startClothingPurchaseSimulation(); // 次のシミュレーションを開始
            } else {
                // これは予期しないパスだが、念のため
                currentPageIndex = 11;
                updatePageDisplay();
            }
        }

        // 初期表示
        updatePageDisplay();

        // モーダルを表示する関数
        function showModal(message, isLoading = false) {
            modalMessage.textContent = message;
            if (isLoading) {
                loadingSpinner.classList.remove('hidden');
                modalCloseButton.classList.add('hidden'); 
            } else {
                loadingSpinner.classList.add('hidden');
                modalCloseButton.classList.remove('hidden');
            }
            statusModal.style.display = 'flex'; 
        }

        // モーダルを閉じる関数
        function closeModal() {
            statusModal.style.display = 'none';
        }

        // 閉じるボタンにイベントリスナーを追加
        modalCloseButton.addEventListener('click', closeModal);
        window.addEventListener('click', (event) => {
            if (event.target == statusModal) {
                closeModal();
            }
        });

        // フォーム送信処理を関数化
        async function submitForm(event) {
            event.preventDefault(); // デフォルトのフォーム送信をキャンセル
            
            // Google Apps ScriptのURLが設定されているか確認
            if (GOOGLE_APPS_SCRIPT_URL === 'YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_HERE' || !GOOGLE_APPS_SCRIPT_URL) { 
                showModal('エラー: Google Apps ScriptのURLが設定されていません。', false);
                return;
            }

            showModal('回答を送信しています...', true); // 送信中にローディングを表示

            // 全ての回答データを収集
            const data = {};
            // surveyAnswersに保存された動的な質問の回答を追加
            for (const key in surveyAnswers) {
                data[key] = surveyAnswers[key];
            }

            // フォームの静的な要素から回答を追加
            const formData = new FormData(form);
            for (let [key, value] of formData.entries()) {
                // surveyAnswersに既に同じキーがなければ追加（動的な質問の重複を避けるため）
                if (!data.hasOwnProperty(key)) {
                    // ラジオボタンやチェックボックスはname属性が重複するため、チェックされているもののみ追加
                    if ((form.elements[key] && (form.elements[key].type === 'radio' || form.elements[key].type === 'checkbox'))) {
                        if (form.elements[key].checked) { // checked状態のラジオボタン/チェックボックスの値のみ取得
                            data[key] = value;
                        }
                    } else {
                        data[key] = value;
                    }
                }
            }
            
            try {
                const response = await fetch(GOOGLE_APPS_SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // CORSエラーを避けるためにno-corsを使用
                    headers: {
                        'Content-Type': 'application/json', // JSON形式で送信
                    },
                    body: JSON.stringify(data), // JavaScriptオブジェクトをJSON文字列に変換して送信
                });

                showModal('回答が正常に送信されました。お知り合いにも共有して頂けると幸いです。ご協力ありがとうございました。', false);
                form.reset(); // フォームをリセット
                currentPageIndex = 0; // 最初のページに戻す
                updatePageDisplay(); // 最初のページを表示
                surveyAnswers = {}; // 回答データをリセット
                // シミュレーションの状態もリセット
                shuffledClothingSimulations = [];
                currentSimulationRoundIndex = 0;
                currentSimulationData = null;
            } catch (error) {
                console.error('送信エラー:', error);
                showModal('送信中にエラーが発生しました。もう一度お試しください。', false);
            }
        }

        // フォーム全体のsubmitイベントリスナーを登録
        form.addEventListener('submit', submitForm);
    </script>
</body>
</html>
